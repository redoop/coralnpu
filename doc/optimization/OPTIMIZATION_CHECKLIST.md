# CoreMiniAxi 优化检查清单

## 目标
从 440,344 instances 优化到 100,000 instances

---

## 阶段 1: RTL 参数优化

### Parameters.scala 修改
- [ ] 修改 `instructionLanes`: 4 → 2
- [ ] 修改 `rvvVlen`: 128 → 64
- [ ] 修改 `fetchDataBits`: 256 → 128
- [ ] 更新 `MemoryRegions.default` ITCM: 0x2000 → 0x1000
- [ ] 更新 `MemoryRegions.default` DTCM: 0x8000 → 0x2000

### CoreAxi.scala 修改
- [ ] 修改 `itcmSizeBytes`: 8KB → 4KB
- [ ] 修改 `dtcmSizeBytes`: 32KB → 8KB

### 验证修改
- [ ] 检查语法错误
- [ ] 确认所有修改已保存

**预期减少**: ~145,000 instances (33%)

---

## 阶段 2: 重新生成 Verilog

### 构建
- [ ] 运行 `bazel build //hdl/chisel/src/coralnpu:core_mini_axi_verilog`
- [ ] 检查构建是否成功
- [ ] 复制生成的 Verilog 到 synthesis 目录

### 验证
- [ ] 检查生成的 Verilog 文件大小
- [ ] 确认文件包含优化后的参数

---

## 阶段 3: 标准综合优化

### 运行综合
- [ ] 进入 synthesis 目录
- [ ] 运行 `yosys -s optimize_synth.tcl`
- [ ] 检查综合是否成功完成

### 分析结果
- [ ] 查看 `optimized_stat.json`
- [ ] 记录 instance 数量: __________
- [ ] 计算减少量: __________
- [ ] 计算减少比例: __________%

### 验证
- [ ] 检查生成的网表文件
- [ ] 查看综合日志是否有警告

**预期减少**: ~90,000 instances (20%)
**预期总 instances**: ~205,000

---

## 阶段 4: 结果比较

### 运行比较工具
- [ ] 运行 `python3 compare_results.py`
- [ ] 查看详细的比较报告
- [ ] 分析各类单元的变化

### 评估
- [ ] 触发器减少: __________
- [ ] MUX 减少: __________
- [ ] 逻辑门减少: __________
- [ ] 缓冲器减少: __________

---

## 阶段 5: 功能验证

### 运行测试
- [ ] 运行 `bazel test //tests/...`
- [ ] 检查所有测试是否通过
- [ ] 记录任何失败的测试

### 功能检查
- [ ] 验证基本功能正常
- [ ] 检查关键路径
- [ ] 确认接口兼容性

---

## 阶段 6: 评估是否需要进一步优化

### 当前状态
- 当前 instances: __________
- 距离目标: __________
- 完成度: __________%

### 决策点
- [ ] 如果 instances > 150,000，继续阶段 7 (激进优化)
- [ ] 如果 instances > 120,000，考虑阶段 8 (功能裁剪)
- [ ] 如果 instances ≤ 120,000，考虑阶段 9 (架构优化)
- [ ] 如果 instances ≤ 100,000，完成！跳到阶段 10

---

## 阶段 7: 激进综合优化 (可选)

### 运行激进优化
- [ ] 运行 `yosys -s aggressive_optimize.tcl`
- [ ] 检查综合是否成功完成
- [ ] 记录 instance 数量: __________

### 比较结果
- [ ] 与标准优化比较
- [ ] 评估额外的减少量: __________
- [ ] 决定使用哪个版本

**预期额外减少**: ~20,000 instances
**预期总 instances**: ~185,000

---

## 阶段 8: 功能裁剪 (可选)

### 评估需求
- [ ] 确认是否需要 Debug Module
- [ ] 确认是否需要 Float 支持
- [ ] 确认是否需要 RVV 支持
- [ ] 确认是否需要 Verification 逻辑

### 修改 Parameters.scala
- [ ] 设置 `enableDebug = false` (如果不需要)
- [ ] 设置 `enableFloat = false` (如果不需要)
- [ ] 设置 `enableRvv = false` (如果不需要)
- [ ] 设置 `enableVerification = false` (如果不需要)

### 重新构建和综合
- [ ] 重新生成 Verilog
- [ ] 重新运行综合
- [ ] 记录新的 instance 数量: __________

**预期减少**: ~50,000 instances

---

## 阶段 9: 架构优化 (可选)

### 进一步减少数据宽度
- [ ] 评估性能影响
- [ ] 修改 `lsuDataBits`: 128 → 64
- [ ] 修改 `fetchDataBits`: 128 → 64 (如果还未修改)

### 减少缓存大小
- [ ] 修改 `l1islots`: 256 → 128
- [ ] 修改 `l1dslots`: 256 → 128
- [ ] 修改 `fetchCacheBytes`: 1024 → 512

### 重新构建和综合
- [ ] 重新生成 Verilog
- [ ] 重新运行综合
- [ ] 记录新的 instance 数量: __________

**预期减少**: ~50,000 instances

---

## 阶段 10: 最终验证

### 功能验证
- [ ] 运行完整测试套件
- [ ] 验证所有关键功能
- [ ] 检查性能指标

### 时序验证
- [ ] 运行时序分析 (如果有工具)
- [ ] 检查是否有时序违例
- [ ] 评估最大频率

### 面积验证
- [ ] 确认最终 instance 数量
- [ ] 生成面积报告
- [ ] 与目标比较

### 文档
- [ ] 更新优化报告
- [ ] 记录最终配置
- [ ] 文档化任何权衡

---

## 最终结果

### 统计
- **初始 instances**: 440,344
- **最终 instances**: __________
- **总减少量**: __________
- **减少比例**: __________%
- **目标达成**: [ ] 是 [ ] 否

### 应用的优化
- [ ] RTL 参数优化
- [ ] 标准综合优化
- [ ] 激进综合优化
- [ ] 功能裁剪
- [ ] 架构优化

### 性能影响
- **频率变化**: __________%
- **功能影响**: __________
- **可接受**: [ ] 是 [ ] 否

---

## 问题和注意事项

### 遇到的问题
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 解决方案
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 建议
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

---

## 签名

- **执行人**: _______________
- **审核人**: _______________
- **日期**: _______________
- **版本**: _______________

---

## 附录: 快速命令参考

```bash
# 重新生成 Verilog
bazel build //hdl/chisel/src/coralnpu:core_mini_axi_verilog
cp bazel-bin/hdl/chisel/src/coralnpu/CoreMiniAxi.sv synthesis/

# 运行优化
cd synthesis
./run_optimization.sh

# 或手动运行
yosys -s optimize_synth.tcl
yosys -s aggressive_optimize.tcl

# 比较结果
python3 compare_results.py baseline.json optimized.json aggressive.json

# 运行测试
bazel test //tests/...
```
